<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rutas Ocultas</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <style>
    :root{
      --primary:#1e3a5f;
      --accent:#ff0066;
    }
    body{
      margin:0;
      padding:0;
    }
    #map{height:60vh;min-height:300px;border:2px solid var(--primary);border-radius:6px;}
    header h1{color:var(--primary);margin-bottom:0;}
    button{background-color:var(--primary);color:white;}
    button:hover{background-color:#163151;}
    .route-list small{color:#555;}
  </style>
</head>
<body>
<header class="container">
  <h1>Rutas Ocultas</h1>
  <p>Descubre itinerarios poco conocidos</p>
</header>
<main class="container">
  <form id="form">
    <label>Ciudad<input id="city" required placeholder="Ej. Santander"></label>
    <label>Tipo de ruta
      <select id="interest">
        <option value="history">Historia</option>
        <option value="street_art">Arte urbano</option>
        <option value="nature">Naturaleza</option>
        <option value="esoteric">Esotérica</option>
      </select>
    </label>
    <label>Duración
      <select id="duration">
        <option value="1">1 h</option>
        <option value="2">2 h</option>
        <option value="3">3 h</option>
      </select>
    </label>
    <button id="generate" type="submit">Generar ruta</button>
  </form>
  <div id="map"></div>
  <section class="route-list">
    <h3>Resumen de la ruta</h3>
    <div id="summary"></div>
  </section>
</main>
<footer class="container">
  &copy; Rutas Ocultas 2025
</footer>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map, routeLayer;
window.addEventListener('DOMContentLoaded', () => {
  map = L.map('map').setView([40.4168, -3.7038], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap'}).addTo(map);
  routeLayer = L.layerGroup().addTo(map);
});
const toRad = d => d * Math.PI / 180;
const haversine = (lat1,lon1,lat2,lon2) => {
  const R = 6371e3;
  const a = Math.sin((toRad(lat2-lat1))/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin((toRad(lon2-lon1))/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
};
async function geocode(city){
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
  const data = await fetch(url).then(r=>r.json());
  return data[0];
}
async function fetchPOIs(lat,lon,type,rad=3000){
  const filters={
    history:'[historic]',
    street_art:'[tourism=artwork]',
    nature:'[leisure~"park|garden"]',
    esoteric:'[amenity=place_of_worship]|[historic=cemetery]|[historic=memorial]'
  };
  const generic='[tourism~"museum|attraction|viewpoint"]';
  const f=filters[type]||'';
  const query=`[out:json][timeout:25];(node(around:${rad},${lat},${lon})${f}[name];node(around:${rad},${lat},${lon})${generic}[name];);out body;`;
  const resp=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:query});
  const json=await resp.json();
  return json.elements||[];
}
function buildRoute(pois, base, dur){
  const startLat=parseFloat(base.lat), startLon=parseFloat(base.lon);
  const maxStops=dur*3;
  pois.forEach(p=>{
    p._w = (p.tags.wikipedia||p.tags.historic||p.tags.tourism==='museum')?0:(p.tags.tourism==='attraction'?1:2);
  });
  pois.sort((a,b)=>a._w-b._w);
  const candidates=pois.slice(0,maxStops*3);
  const route=[{lat:startLat,lon:startLon,name:base.display_name,tags:{}}];
  let prevLat=startLat,prevLon=startLon,dist=0;
  while(candidates.length && route.length<=maxStops){
    candidates.sort((a,b)=>haversine(prevLat,prevLon,a.lat,a.lon)-haversine(prevLat,prevLon,b.lat,b.lon));
    const next=candidates.shift();
    const d=haversine(prevLat,prevLon,next.lat,next.lon);
    if(dist+d > dur*4*1000) continue;
    dist += d;
    route.push({lat:next.lat,lon:next.lon,name:next.tags.name||'POI',tags:next.tags});
    prevLat=next.lat; prevLon=next.lon;
  }
  return route;
}
function drawRoute(pts){
  routeLayer.clearLayers();
  const latlngs=pts.map(p=>[+p.lat,+p.lon]);
  L.polyline(latlngs,{color:'#ff0066'}).addTo(routeLayer);
  pts.forEach((p,i)=>{
    L.marker([p.lat,p.lon]).addTo(routeLayer).bindPopup(`${i}. ${p.name}`);
  });
  map.fitBounds(latlngs,{padding:[20,20]});
}
async function fetchDescription(poi){
  if(!poi.tags?.wikipedia) return '';
  const [lang,title]=poi.tags.wikipedia.split(':');
  try{
    const url=`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
    const data=await fetch(url).then(r=>r.json());
    return data.extract||'';
  }catch{
    return '';
  }
}
async function generate(e){
  e.preventDefault();
  const city=document.getElementById('city').value.trim();
  const type=document.getElementById('interest').value;
  const dur=parseInt(document.getElementById('duration').value,10);
  const base=await geocode(city);
  if(!base) return alert('Ciudad no encontrada');
  const pois=await fetchPOIs(base.lat,base.lon,type,3000);
  const route=buildRoute(pois,base,dur);
  drawRoute(route);
  const list=document.createElement('ul');
  list.innerHTML=`<li>Punto de salida: ${base.display_name}</li>`;
  for(let i=1;i<route.length;i++){
    const desc=await fetchDescription(route[i]);
    const item=document.createElement('li');
    item.innerHTML=`Parada ${i}: ${route[i].name}${desc?`<br><small>${desc}</small>`:''}`;
    list.appendChild(item);
  }
  document.getElementById('summary').innerHTML='';
  document.getElementById('summary').appendChild(list);
}
document.getElementById('form').addEventListener('submit',generate);
</script>
</body>
</html>
